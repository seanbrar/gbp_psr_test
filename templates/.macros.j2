{#-
This changelog uses Keep a Changelog format with categories mapped from
conventional commit types. Categories like "Deprecated", "Removed", and 
"Security" would require manual entries since they don't map to standard
commit types.
-#}

{#-
This dictionary maps the commit types from the parser to the
human-readable section titles in the changelog.
-#}
{%- set sections = {
"features": "Added",
"bug fixes": "Fixed", 
"performance improvements": "Changed",
"documentation": "Changed"
} -%}

{#-
This dictionary groups commit types by their section title.
e.g., {"Added": ["features"], "Changed": ["performance improvements", "documentation"], ...}
-#}
{%- set sections_by_title = {} -%}
{%- for section_key, section_title in sections.items() -%}
{%- if section_title not in sections_by_title -%}
{%- set _ = sections_by_title.update({section_title: []}) -%}
{%- endif -%}
{%- do sections_by_title[section_title].append(section_key) -%}
{%- endfor -%}

{#-
This list defines the order in which sections should appear in the changelog.
-#}
{%- set section_order = ["Added", "Fixed", "Changed"] -%}

{#-
Macro to check if there are any commits that will actually be rendered.
-#}
{%- macro has_renderable_commits(commits_by_type) -%}
{%- set ns = namespace(found=false) -%}
{%- for section_key in sections.keys() -%}
{%- if commits_by_type.get(section_key) -%}
{%- set ns.found = true -%}
{%- break -%}
{%- endif -%}
{%- endfor -%}
{%- if ns.found -%}true{%- endif -%}
{%- endmacro -%}

{#- Macro to render the content of a single commit line. -#}
{%- macro render_commit_content(commit) -%}
{{ " " }}
{%- if commit.descriptions and commit.descriptions[0] -%}
{{- commit.descriptions[0][0] | upper ~ commit.descriptions[0][1:] -}}
{%- endif -%}
{{- " " -}}
([`{{ commit.short_hash }}`]({{ commit.hexsha | commit_hash_url }}))
{% if commit.linked_issues -%}
{{- " " -}}
({%- for issue in commit.linked_issues -%}
[{{- issue }}]({{ issue | issue_url }})
{%- if not loop.last -%}, {% endif -%}
{%- endfor -%})
{%- endif -%}
{%- endmacro -%}

{#-
Iterates through the defined sections and renders the commits for each.
-#}
{%- macro render_changelog_entry(release_data) -%}
{#- Create a list of section titles that have commits for this release -#}
{%- set populated_section_titles = [] -%}
{%- for section_title in section_order -%}
{%- if sections_by_title.get(section_title) -%}
{%- set has_commits = namespace(found=false) -%}
{%- for section_key in sections_by_title[section_title] -%}
{%- if release_data[section_key] -%}
{%- set has_commits.found = true -%}
{%- break -%}
{%- endif -%}
{%- endfor -%}
{%- if has_commits.found -%}
{%- do populated_section_titles.append(section_title) -%}
{%- endif -%}
{%- endif -%}
{%- endfor -%}

{#- Now loop over only the populated section titles -#}
{%- for section_title in populated_section_titles %}
### {{ section_title }}

{% set all_commits_for_section = [] %}
{% for section_key in sections_by_title[section_title] %}
{% if release_data[section_key] %}
{% do all_commits_for_section.extend(release_data[section_key]) %}
{% endif %}
{% endfor %}
{% for commit in all_commits_for_section | sort(attribute='scope') %}
-{{ render_commit_content(commit) -}}
{% endfor %}
{%- if not loop.last %}

{% endif %}
{%- endfor -%}
{% if populated_section_titles %}

{% endif %}
{%- endmacro %}

{#- Macro to render the comparison links for all releases. -#}
{%- macro render_comparison_links(history) -%}
{%- set links = [] %}
{%- set releases = history.released.values() | list | sort(attribute='version', reverse=true) %}
{%- if releases %}
{#- Generate the base URL for creating links -#}
{%- set base_url = (("v" ~ releases[-1].version) | compare_url("HEAD")) | replace("compare/v" ~ releases[-1].version ~
"...HEAD", "") %}
{#- Link for unreleased changes, comparing the latest release to HEAD -#}
{%- if history.unreleased and has_renderable_commits(history.unreleased) %}
{%- set unreleased_link = "[Unreleased]: " ~ (("v" ~ releases[0].version) | compare_url("HEAD")) %}
{%- do links.append(unreleased_link) %}
{%- endif %}
{#- Links for each versioned release -#}
{%- for release in releases %}
{%- if loop.last %}
{#- The oldest release links to its tag from the beginning of history -#}
{%- set release_link = "[" ~ release.version ~ "]: " ~ (base_url ~ "releases/tag/v" ~ release.version) %}
{%- else %}
{#- Subsequent releases link to the comparison between it and the previous one -#}
{%- set release_link = "[" ~ release.version ~ "]: " ~ (("v" ~ loop.nextitem.version) | compare_url("v" ~
release.version)) %}
{%- endif %}
{%- set _ = links.append(release_link) %}
{%- endfor %}
{%- endif %}
{{ links | join('\n') -}}
{%- endmacro -%}