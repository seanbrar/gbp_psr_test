{%- import ".macros.j2" as macros -%}

{#- Determine whether to use init mode logic -#}
{%- if context.changelog_mode == 'update' -%}
{%- set prev_content = context.prev_changelog_file | read_file | safe -%}
{%- set use_init_mode = prev_content | trim | length == 0 or '<!-- PSR-INSERT-FLAG -->' not in prev_content -%}
{%- else -%}
{%- set use_init_mode = true -%}
{%- endif -%}

{%- if use_init_mode -%}
{#- INIT MODE: Render full history and links from scratch -#}
{% block header %}
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

<!-- PSR-INSERT-FLAG -->
{% endblock header %}

{#- Main block to render the entire release history -#}
{% block content %}
{% if context.history.unreleased and macros.has_renderable_commits(context.history.unreleased) %}
## [Unreleased]
{{ macros.render_release_sections(context.history.unreleased) -}}
{% endif %}
{%- for version, release in context.history.released.items() %}
{% if context.history.unreleased and macros.has_renderable_commits(context.history.unreleased) or not loop.first %}

---

{% endif %}
## [{{ release.version }}] - {{ release.tagged_date.strftime('%Y-%m-%d') }}
{{ macros.render_release_sections(release.elements) }}
{%- endfor %}
{% endblock content %}

{% block footer %}
---

<!-- PSR-LINKS-START -->
{{ macros.render_comparison_links(context.history) }}
{% endblock footer %}

{%- else -%}
{#- UPDATE MODE: Prepend new release and regenerate links (Corrected Logic) -#}
{%- set content_parts = prev_content.split('<!-- PSR-INSERT-FLAG -->', 1) -%}
{%- set old_content_and_links = content_parts[1] | default('') -%}
{%- set old_releases, _, _ = old_content_and_links.partition('<!-- PSR-LINKS-START -->') %}

{%- set releases = context.history.released.values() | sort(attribute='version', reverse=true) -%}
{%- set latest_release = releases[0] -%}

{{- content_parts[0] -}}
## [{{ latest_release.version }}] - {{ latest_release.tagged_date.strftime('%Y-%m-%d') }}
{{ macros.render_release_sections(latest_release.elements) }}
{%- if old_releases | trim != "" %}

---

{%- endif -%}
{{- old_releases | trim }}

---
<!-- PSR-LINKS-START -->
{{ macros.render_comparison_links(context.history) }}
{%- endif -%}

{%- block release_notes %}
{#-
  This block populates the 'release_notes' output.
  It renders ONLY the sections for the most recent release.
-#}
{%- if context.history.released %}
    {%- set releases = context.history.released.values() | sort(attribute='version', reverse=true) -%}
    {%- set latest_release = releases[0] -%}
    {{- macros.render_release_sections(latest_release.elements) -}}
{%- endif %}
{%- endblock release_notes -%}